name: Strip Credentials

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  strip-credentials:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Strip credentials from sample files
        run: |
          # Replace Firebase credentials with placeholders in Program.cs
          sed -i \
            -e 's/\.WithProject("[^"]*")/.WithProject("your-project-id")/g' \
            -e 's/\.WithApiKey("[^"]*")/.WithApiKey("your-api-key")/g' \
            -e 's/\.WithAppId("[^"]*")/.WithAppId("your-app-id")/g' \
            -e 's/\.WithAuthDomain("[^"]*")/.WithAuthDomain("your-project.firebaseapp.com")/g' \
            -e 's/\.WithStorageBucket("[^"]*")/.WithStorageBucket("your-project.firebasestorage.app")/g' \
            -e 's/\.WithDatabaseUrl("[^"]*")/.WithDatabaseUrl("https:\/\/your-project.firebasedatabase.app")/g' \
            -e 's/\.ReCaptchaV3("[^"]*")/.ReCaptchaV3("your-recaptcha-site-key")/g' \
            -e 's/\.ReCaptchaEnterprise("[^"]*")/.ReCaptchaEnterprise("your-recaptcha-enterprise-key")/g' \
            samples/FireBlazor.Sample.Wasm/Program.cs

      - name: Check for remaining credentials
        run: |
          # Fail if any real credentials remain (basic pattern check)
          if grep -E "(AIzaSy|:web:|firebaseapp\.com\"[^y])" samples/FireBlazor.Sample.Wasm/Program.cs; then
            echo "ERROR: Credentials may still be present!"
            exit 1
          fi
          echo "Credentials successfully stripped"

      - name: Commit changes (if any)
        if: github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git diff --quiet || (git add -A && git commit -m "chore: strip credentials from samples [skip ci]" && git push)
